<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workout Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0d12">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg: #0b0d12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 12px 34px rgba(0,0,0,.45);
      --radius: 16px;
      --radius2: 20px;
      --ring: 0 0 0 3px rgba(99,102,241,.35);
      --accent: #7c3aed;
      --accent2: #22c55e;
      --danger: #ef4444;
      --danger2: #b91c1c;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(700px 500px at 50% 100%, rgba(59,130,246,.12), transparent 60%),
        var(--bg);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,.15));
      border-bottom: 1px solid var(--border);
    }
    .headerInner{
      max-width: 1160px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .logo{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(59,130,246,.65));
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: white;
      letter-spacing: -.02em;
      user-select:none;
    }
    .brandText{ min-width: 0; }
    .brandTitle{
      font-size: 15px;
      font-weight: 800;
      margin: 0;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brandSub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }
    .tabBtn{
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 750;
      font-size: 13px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select: none;
    }
    .tabBtn:active{ transform: translateY(1px); }
    .tabBtn.active{
      border-color: rgba(124,58,237,.55);
      box-shadow: var(--ring);
      background: rgba(124,58,237,.14);
    }

    /* Layout */
    .page{
      max-width: 1160px;
      margin: 0 auto;
      padding: 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    h2{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      font-weight: 850;
    }
    .pill{
      font-size: 12px;
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      background: rgba(255,255,255,.04);
      white-space: nowrap;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
      font-weight: 700;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    input, textarea, button{ font: inherit; }
    input, textarea{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      outline: none;
      transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
    }
    input::placeholder, textarea::placeholder{ color: var(--muted2); }
    input:focus, textarea:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: var(--ring);
      background: rgba(255,255,255,.08);
    }
    textarea{
      min-height: 82px;
      resize: vertical;
      line-height: 1.35;
    }

    .actions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn{
      width: 100%;
      border-radius: 14px;
      padding: 11px 12px;
      border: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(59,130,246,.70));
      border-color: rgba(124,58,237,.55);
      color: white;
      font-weight: 850;
    }
    .btnSecondary{
      background: rgba(255,255,255,.06);
      color: var(--text);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(185,28,28,.70));
      border-color: rgba(239,68,68,.55);
      color: white;
      font-weight: 850;
    }
    .btnSmall{
      width: auto;
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 800;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
      margin: 10px 0 0;
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 14px 0;
    }

    /* Workouts list */
    .list{ display:grid; gap: 10px; margin-top: 10px; }
    .groupHeader{
      margin-top: 12px;
      padding-top: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      border-top: 1px solid var(--border);
    }

    .workoutItem{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: rgba(255,255,255,.04);
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .workoutItem:hover{ background: rgba(255,255,255,.06); }
    .workoutItem:active{ transform: translateY(1px); }
    .workoutItem.active{
      border-color: rgba(124,58,237,.55);
      box-shadow: var(--ring);
      background: rgba(124,58,237,.12);
    }
    .workoutTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .dateStrong{ font-weight: 900; letter-spacing: -.01em; }
    .titleLine{ font-weight: 850; letter-spacing: -.01em; line-height: 1.25; }
    .snippet{ color: var(--muted); font-size: 12px; line-height: 1.35; margin-top: 4px; }

    /* Detail */
    .detailTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .detailDate{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .detailTitle{ font-size: 20px; font-weight: 950; letter-spacing: -.02em; margin: 2px 0 0; }

    /* Exercises */
    .exercise{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: rgba(255,255,255,.04);
    }
    .exerciseHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .exerciseName{
      font-weight: 950;
      letter-spacing: -.01em;
    }
    .inlineBtns{
      display:flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .sets{
      margin-top: 10px;
      display:grid;
      gap: 10px;
    }
    .setRow{
      display:grid;
      grid-template-columns: 70px 1fr 1fr 1fr;
      gap: 8px;
      align-items:center;
    }
    @media (max-width: 520px){
      .setRow{ grid-template-columns: 60px 1fr 1fr; }
      .setRow .col3{ grid-column: span 2; }
    }
    .setNum{ font-size: 12px; color: var(--muted); font-weight: 800; }

    /* Calendar */
    .calHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .calTitle{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: -.02em;
    }
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .dow{
      font-size: 11px;
      color: var(--muted);
      font-weight: 850;
      text-transform: uppercase;
      letter-spacing: .10em;
      padding: 6px 6px 2px;
    }
    .day{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      min-height: 90px;
      padding: 10px;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .08s ease;
      position: relative;
      overflow: hidden;
    }
    .day:hover{ background: rgba(255,255,255,.06); }
    .day:active{ transform: translateY(1px); }
    .day.mutedDay{
      opacity: .45;
    }
    .day.active{
      border-color: rgba(124,58,237,.55);
      box-shadow: var(--ring);
      background: rgba(124,58,237,.12);
    }
    .dayNum{
      font-weight: 950;
      letter-spacing: -.01em;
      font-size: 13px;
    }
    .dots{
      display:flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .dot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(124,58,237,.95);
      box-shadow: 0 0 0 2px rgba(124,58,237,.15);
    }
    .badge{
      margin-top: 10px;
      display:inline-flex;
      gap: 6px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 6px 10px;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10,12,18,.92);
      color: white;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 80;
      max-width: calc(100% - 32px);
      text-align: center;
      font-weight: 750;
    }
    .toast.show{ opacity: 1; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="headerInner">
    <div class="brand">
      <div class="logo">üèãÔ∏è</div>
      <div class="brandText">
        <p class="brandTitle">Workout Tracker</p>
        <p class="brandSub">Dark mode ‚Ä¢ Calendar ‚Ä¢ Backup anytime</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabWorkoutsBtn" data-tab="workouts">Workouts</button>
      <button class="tabBtn" id="tabCalendarBtn" data-tab="calendar">Calendar</button>
      <button class="btn btnSecondary btnSmall" id="exportBtn" title="Copy all data as JSON">Export</button>
      <button class="btn btnSecondary btnSmall" id="importBtn" title="Import from a JSON backup">Import</button>
      <button class="btn btnSecondary btnSmall" id="backupBtn" title="Download a JSON backup file">Backup</button>
    </div>
  </div>
</header>

<div class="page">

  <!-- WORKOUTS TAB -->
  <div id="tabWorkouts">
    <div class="grid">
      <!-- Left: create + history -->
      <section class="card">
        <div class="sectionTitle">
          <h2>New workout</h2>
          <span class="pill">quick add</span>
        </div>

        <div class="row">
          <div>
            <label>Date</label>
            <input type="date" id="dateInput" />
          </div>
          <div>
            <label>Title</label>
            <input type="text" id="titleInput" placeholder="Push / Pull / Legs..." />
          </div>
        </div>

        <label>Notes</label>
        <textarea id="notesInput" placeholder="How you felt, goals, cues, etc."></textarea>

        <div class="actions">
          <button class="btn btnPrimary" id="createWorkoutBtn">Create workout</button>
          <button class="btn btnSecondary" id="clearAllBtn" title="Deletes all workouts on this device">Clear all</button>
        </div>

        <p class="muted">Tip: use ‚ÄúBackup‚Äù once in a while so you never lose your logs.</p>

        <div class="divider"></div>

        <div class="sectionTitle">
          <h2>History</h2>
          <span class="pill" id="historyCountPill">0</span>
        </div>

        <label>Search</label>
        <input id="searchInput" placeholder="bench, squat, legs..." />

        <div class="list" id="workoutList"></div>
      </section>

      <!-- Right: workout detail -->
      <section class="card">
        <div id="emptyState" class="muted">
          Select a workout from the left (or create one).
        </div>

        <div id="detail" class="hidden">
          <div class="detailTop">
            <div>
              <div class="detailDate" id="detailDate"></div>
              <div class="detailTitle" id="detailTitle"></div>
            </div>
            <button class="btn btnDanger btnSmall" id="deleteWorkoutBtn">Delete</button>
          </div>

          <label style="margin-top:12px;">Workout notes</label>
          <textarea id="detailNotes" placeholder="Notes for this session..."></textarea>

          <div class="divider"></div>

          <div class="sectionTitle">
            <h2>Exercises</h2>
            <span class="pill" id="exerciseCountPill">0 exercises</span>
          </div>

          <div class="row">
            <div>
              <label>Add exercise</label>
              <input id="exerciseNameInput" placeholder="Bench Press" />
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn btnPrimary" id="addExerciseBtn">Add</button>
            </div>
          </div>

          <div id="exerciseList"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- CALENDAR TAB -->
  <div id="tabCalendar" class="hidden">
    <div class="grid">
      <section class="card">
        <div class="calHeader">
          <div>
            <div class="calTitle" id="calTitle">Month</div>
            <div class="muted" id="calSubtitle">Tap a day to see workouts</div>
          </div>
          <div class="inlineBtns">
            <button class="btn btnSecondary btnSmall" id="calPrevBtn">‚óÄ</button>
            <button class="btn btnSecondary btnSmall" id="calTodayBtn">Today</button>
            <button class="btn btnSecondary btnSmall" id="calNextBtn">‚ñ∂</button>
          </div>
        </div>

        <div class="calGrid" id="calDow"></div>
        <div class="calGrid" id="calGrid"></div>

        <div style="margin-top: 12px;">
          <span class="badge" id="calLegend">
            <span class="dot"></span> Day with workouts
          </span>
        </div>
      </section>

      <section class="card">
        <div class="sectionTitle">
          <h2 id="calDayTitle">Selected day</h2>
          <span class="pill" id="calDayCountPill">0</span>
        </div>

        <div class="muted" id="calDayHint">Pick a day on the calendar.</div>

        <div class="list" id="calDayWorkoutList"></div>
      </section>
    </div>
  </div>

</div>

<input type="file" id="filePicker" accept="application/json" style="display:none;" />
<div class="toast" id="toast"></div>

<script>
  // ---------- Storage ----------
  const KEY = "workout_tracker_v1";
  const load = () => JSON.parse(localStorage.getItem(KEY) || '{"workouts":[]}');
  const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));
  const uid = () => crypto.randomUUID();

  // ---------- State ----------
  let db = load();
  let selectedWorkoutId = null;

  // calendar state
  const today = new Date();
  let calYear = today.getFullYear();
  let calMonth = today.getMonth(); // 0-11
  let selectedDateStr = null; // "YYYY-MM-DD"

  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1200);
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function sortWorkouts(){
    db.workouts.sort((a,b) => (b.date || "").localeCompare(a.date || ""));
  }

  function workoutsFiltered(){
    const q = $("searchInput").value.trim().toLowerCase();
    if (!q) return db.workouts;
    return db.workouts.filter(w => {
      const hay = [
        w.title || "",
        w.notes || "",
        ...w.exercises.map(e => e.name),
        ...w.exercises.flatMap(e => e.sets.map(s => `${s.weight||""} ${s.reps||""} ${s.notes||""}`))
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  function selectWorkout(id){
    selectedWorkoutId = id;
    renderWorkoutsTab();
    // also refresh calendar side list (if it shows same day's items)
    renderCalendarDayList();
  }

  function getSelectedWorkout(){
    return db.workouts.find(w => w.id === selectedWorkoutId) || null;
  }

  function monthKeyFromDateStr(dateStr){
    // "YYYY-MM-DD" -> "YYYY-MM"
    return (dateStr || "").slice(0,7);
  }

  function monthLabel(yyyyMM){
    const [y, m] = yyyyMM.split("-").map(Number);
    const d = new Date(y, m - 1, 1);
    return d.toLocaleString(undefined, { month: "long", year: "numeric" });
  }

  function dateToStr(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function workoutsByDateMap(){
    const map = new Map(); // dateStr -> workouts[]
    for (const w of db.workouts){
      if (!map.has(w.date)) map.set(w.date, []);
      map.get(w.date).push(w);
    }
    // keep newest first per day
    for (const [k, arr] of map.entries()){
      arr.sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    }
    return map;
  }

  // ---------- CRUD ----------
  function createWorkout(){
    const date = $("dateInput").value;
    const title = $("titleInput").value.trim();
    const notes = $("notesInput").value.trim();

    if (!date) return alert("Pick a date.");

    const w = { id: uid(), date, title, notes, exercises: [] };
    db.workouts.push(w);
    sortWorkouts();
    save(db);

    $("titleInput").value = "";
    $("notesInput").value = "";

    toast("Workout created");
    selectWorkout(w.id);

    // If calendar is on same month, refresh dots
    renderCalendar();
  }

  function deleteWorkout(){
    const w = getSelectedWorkout();
    if (!w) return;
    if (!confirm("Delete this workout?")) return;

    db.workouts = db.workouts.filter(x => x.id !== w.id);
    selectedWorkoutId = null;
    save(db);
    toast("Workout deleted");
    renderWorkoutsTab();
    renderCalendar();
    renderCalendarDayList();
  }

  function addExercise(){
    const w = getSelectedWorkout();
    if (!w) return;
    const name = $("exerciseNameInput").value.trim();
    if (!name) return;

    w.exercises.push({ id: uid(), name, sets: [] });
    $("exerciseNameInput").value = "";
    save(db);
    toast("Exercise added");
    renderWorkoutsTab();
  }

  function deleteExercise(exId){
    const w = getSelectedWorkout();
    w.exercises = w.exercises.filter(e => e.id !== exId);
    save(db);
    toast("Exercise deleted");
    renderWorkoutsTab();
  }

  function addSet(exId){
    const w = getSelectedWorkout();
    const ex = w.exercises.find(e => e.id === exId);
    const next = ex.sets.length + 1;
    ex.sets.push({ id: uid(), set_number: next, weight: "", reps: "", rpe: "", notes: "" });
    save(db);
    toast("Set added");
    renderWorkoutsTab();
  }

  function deleteSet(exId, setId){
    const w = getSelectedWorkout();
    const ex = w.exercises.find(e => e.id === exId);
    ex.sets = ex.sets.filter(s => s.id !== setId);
    ex.sets.forEach((s,i)=>s.set_number=i+1);
    save(db);
    toast("Set deleted");
    renderWorkoutsTab();
  }

  function updateWorkoutNotes(val){
    const w = getSelectedWorkout();
    w.notes = val;
    save(db);
  }

  function updateSetField(exId, setId, field, val){
    const w = getSelectedWorkout();
    const ex = w.exercises.find(e => e.id === exId);
    const s = ex.sets.find(x => x.id === setId);
    s[field] = val;
    save(db);
  }

  // ---------- Import/Export ----------
  function exportJSON(){
    const data = JSON.stringify(db, null, 2);
    navigator.clipboard?.writeText(data).then(()=>toast("Copied JSON")).catch(()=>{
      prompt("Copy your data:", data);
    });
  }

  function downloadBackup(){
    const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "workout-tracker-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const incoming = JSON.parse(reader.result);
        if (!incoming || !Array.isArray(incoming.workouts)) throw new Error("Invalid file.");
        db = incoming;
        save(db);
        sortWorkouts();
        selectedWorkoutId = db.workouts[0]?.id ?? null;
        toast("Imported");
        renderAll();
      } catch(e){
        alert("Import failed: " + e.message);
      }
    };
    reader.readAsText(file);
  }

  // ---------- Tabs ----------
  function setActiveTab(tab){
    // buttons
    const buttons = document.querySelectorAll(".tabBtn");
    buttons.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));

    $("tabWorkouts").classList.toggle("hidden", tab !== "workouts");
    $("tabCalendar").classList.toggle("hidden", tab !== "calendar");

    if (tab === "calendar"){
      // default: show current month; select today (or keep selection)
      renderCalendar();
      if (!selectedDateStr) selectedDateStr = dateToStr(new Date());
      renderCalendarDayList();
    }
  }

  // ---------- Render: Workouts ----------
  function renderWorkoutsTab(){
    sortWorkouts();

    // History count
    $("historyCountPill").textContent = String(workoutsFiltered().length);

    // Left list grouped by month
    const list = $("workoutList");
    list.innerHTML = "";

    const items = workoutsFiltered();
    if (items.length === 0){
      list.innerHTML = `<div class="muted">No workouts found.</div>`;
    } else {
      let currentGroup = null;

      for (const w of items){
        const mk = monthKeyFromDateStr(w.date);
        if (mk !== currentGroup){
          currentGroup = mk;
          const gh = document.createElement("div");
          gh.className = "groupHeader";
          gh.textContent = monthLabel(mk);
          list.appendChild(gh);
        }

        const div = document.createElement("div");
        div.className = "workoutItem" + (w.id === selectedWorkoutId ? " active" : "");
        div.onclick = () => selectWorkout(w.id);

        const snippet = (w.notes || "").trim();
        div.innerHTML = `
          <div class="workoutTop">
            <div class="dateStrong">${escapeHtml(w.date)}</div>
            <span class="pill">${w.exercises.length} ex</span>
          </div>
          <div class="titleLine">${escapeHtml(w.title || "Workout")}</div>
          <div class="snippet">${escapeHtml(snippet.slice(0, 70))}${snippet.length>70?"‚Ä¶":""}</div>
        `;
        list.appendChild(div);
      }
    }

    // Detail panel
    const w = getSelectedWorkout();
    if (!w){
      $("emptyState").classList.remove("hidden");
      $("detail").classList.add("hidden");
      return;
    }

    $("emptyState").classList.add("hidden");
    $("detail").classList.remove("hidden");

    $("detailDate").textContent = w.date;
    $("detailTitle").textContent = w.title || "Workout";
    $("detailNotes").value = w.notes || "";
    $("exerciseCountPill").textContent = `${w.exercises.length} exercise${w.exercises.length===1?"":"s"}`;

    const exList = $("exerciseList");
    exList.innerHTML = "";

    for (const ex of w.exercises){
      const exDiv = document.createElement("div");
      exDiv.className = "exercise";

      const setsHtml = ex.sets.map(s => `
        <div class="setRow">
          <div class="setNum">Set ${s.set_number}</div>
          <input inputmode="decimal" placeholder="Weight" value="${escapeHtml(s.weight)}"
            data-ex="${ex.id}" data-set="${s.id}" data-field="weight" />
          <input inputmode="numeric" placeholder="Reps" value="${escapeHtml(s.reps)}"
            data-ex="${ex.id}" data-set="${s.id}" data-field="reps" />
          <div class="col3" style="display:flex; gap:8px;">
            <input inputmode="decimal" placeholder="RPE" value="${escapeHtml(s.rpe)}"
              data-ex="${ex.id}" data-set="${s.id}" data-field="rpe" />
            <button class="btn btnSecondary btnSmall" style="width:auto;" data-delset="1" data-ex="${ex.id}" data-set="${s.id}">‚úï</button>
          </div>
        </div>
        <input placeholder="Set notes (optional)" value="${escapeHtml(s.notes)}"
          data-ex="${ex.id}" data-set="${s.id}" data-field="notes" />
      `).join("");

      exDiv.innerHTML = `
        <div class="exerciseHeader">
          <div class="exerciseName">${escapeHtml(ex.name)}</div>
          <div class="inlineBtns">
            <button class="btn btnSecondary btnSmall" data-addset="1" data-ex="${ex.id}">Add set</button>
            <button class="btn btnDanger btnSmall" data-delex="1" data-ex="${ex.id}">Delete</button>
          </div>
        </div>
        <div class="sets">${setsHtml || '<div class="muted">No sets yet. Click ‚ÄúAdd set‚Äù.</div>'}</div>
      `;
      exList.appendChild(exDiv);
    }
  }

  // ---------- Render: Calendar ----------
  function renderCalendar(){
    // Title
    const d = new Date(calYear, calMonth, 1);
    $("calTitle").textContent = d.toLocaleString(undefined, { month: "long", year: "numeric" });

    // Day-of-week header
    const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const dowEl = $("calDow");
    dowEl.innerHTML = "";
    for (const name of dow){
      const cell = document.createElement("div");
      cell.className = "dow";
      cell.textContent = name;
      dowEl.appendChild(cell);
    }

    // Build month grid (6 rows x 7 = 42)
    const firstDay = new Date(calYear, calMonth, 1);
    const startDow = firstDay.getDay(); // 0=Sun
    const gridStart = new Date(calYear, calMonth, 1 - startDow);

    const map = workoutsByDateMap();

    const grid = $("calGrid");
    grid.innerHTML = "";

    for (let i=0; i<42; i++){
      const dayDate = new Date(gridStart);
      dayDate.setDate(gridStart.getDate() + i);

      const dayStr = dateToStr(dayDate);
      const inMonth = dayDate.getMonth() === calMonth;
      const workouts = map.get(dayStr) || [];

      const cell = document.createElement("div");
      cell.className = "day" + (inMonth ? "" : " mutedDay") + (dayStr === selectedDateStr ? " active" : "");

      const dots = workouts.length
        ? `<div class="dots">${new Array(Math.min(workouts.length, 6)).fill(0).map(()=>`<span class="dot"></span>`).join("")}</div>`
        : "";

      cell.innerHTML = `
        <div class="dayNum">${dayDate.getDate()}</div>
        ${dots}
      `;

      cell.onclick = () => {
        selectedDateStr = dayStr;
        renderCalendar();
        renderCalendarDayList();
      };

      grid.appendChild(cell);
    }
  }

  function renderCalendarDayList(){
    const map = workoutsByDateMap();
    const list = $("calDayWorkoutList");
    const hint = $("calDayHint");

    if (!selectedDateStr){
      $("calDayTitle").textContent = "Selected day";
      $("calDayCountPill").textContent = "0";
      hint.textContent = "Pick a day on the calendar.";
      hint.classList.remove("hidden");
      list.innerHTML = "";
      return;
    }

    const workouts = map.get(selectedDateStr) || [];
    $("calDayTitle").textContent = selectedDateStr;
    $("calDayCountPill").textContent = String(workouts.length);

    list.innerHTML = "";

    if (workouts.length === 0){
      hint.textContent = "No workouts logged on this day.";
      hint.classList.remove("hidden");
      return;
    }

    hint.classList.add("hidden");

    for (const w of workouts){
      const div = document.createElement("div");
      div.className = "workoutItem" + (w.id === selectedWorkoutId ? " active" : "");
      div.onclick = () => {
        // jump to workouts tab + select
        setActiveTab("workouts");
        selectWorkout(w.id);
      };

      const snippet = (w.notes || "").trim();
      div.innerHTML = `
        <div class="workoutTop">
          <div class="dateStrong">${escapeHtml(w.date)}</div>
          <span class="pill">${w.exercises.length} ex</span>
        </div>
        <div class="titleLine">${escapeHtml(w.title || "Workout")}</div>
        <div class="snippet">${escapeHtml(snippet.slice(0, 70))}${snippet.length>70?"‚Ä¶":""}</div>
      `;
      list.appendChild(div);
    }
  }

  // ---------- Render All ----------
  function renderAll(){
    renderWorkoutsTab();
    renderCalendar();
    renderCalendarDayList();
  }

  // ---------- Events ----------
  $("createWorkoutBtn").onclick = createWorkout;
  $("addExerciseBtn").onclick = addExercise;
  $("deleteWorkoutBtn").onclick = deleteWorkout;

  $("searchInput").addEventListener("input", renderWorkoutsTab);

  $("detailNotes").addEventListener("input", (e) => updateWorkoutNotes(e.target.value));

  $("exerciseList").addEventListener("input", (e) => {
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    const exId = el.dataset.ex, setId = el.dataset.set, field = el.dataset.field;
    if (!exId || !setId || !field) return;
    updateSetField(exId, setId, field, el.value);
  });

  $("exerciseList").addEventListener("click", (e) => {
    const el = e.target;
    if (!(el instanceof HTMLElement)) return;

    if (el.dataset.addset) addSet(el.dataset.ex);
    if (el.dataset.delex) deleteExercise(el.dataset.ex);
    if (el.dataset.delset) deleteSet(el.dataset.ex, el.dataset.set);
  });

  $("clearAllBtn").onclick = () => {
    if (!confirm("This deletes ALL workouts on this device/browser. Continue?")) return;
    db = { workouts: [] };
    selectedWorkoutId = null;
    save(db);
    toast("Cleared");
    renderAll();
  };

  $("exportBtn").onclick = exportJSON;
  $("backupBtn").onclick = downloadBackup;

  $("importBtn").onclick = () => $("filePicker").click();
  $("filePicker").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (file) importJSONFile(file);
    e.target.value = "";
  });

  // Tabs click
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
  });

  // Calendar controls
  $("calPrevBtn").onclick = () => {
    calMonth -= 1;
    if (calMonth < 0){ calMonth = 11; calYear -= 1; }
    renderCalendar();
  };
  $("calNextBtn").onclick = () => {
    calMonth += 1;
    if (calMonth > 11){ calMonth = 0; calYear += 1; }
    renderCalendar();
  };
  $("calTodayBtn").onclick = () => {
    const now = new Date();
    calYear = now.getFullYear();
    calMonth = now.getMonth();
    selectedDateStr = dateToStr(now);
    renderCalendar();
    renderCalendarDayList();
  };

  // init date default + initial render
  $("dateInput").value = new Date().toISOString().slice(0,10);
  sortWorkouts();
  selectedWorkoutId = db.workouts[0]?.id ?? null;
  selectedDateStr = dateToStr(new Date());
  renderAll();
</script>

<!-- Service Worker registration (PWA/offline) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js");
    });
  }
</script>
</body>
</html>
